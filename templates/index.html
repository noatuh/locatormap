<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Multi-Phone Tracker with Drawing</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #controls {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 8px;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #controls.hidden { opacity: 0; visibility: hidden; }
    button, select, input { margin: 4px 0; width: 100%; }
    .phone-label {
      background: white; padding: 10px 20px; border-radius: 4px;
      font-size: 12px; display: inline-block;
    }
    #phoneList {
      margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;
    }
    #phoneEntries {
      max-height: 120px; overflow-y: auto; margin-bottom: 5px;
    }
    .phone-entry {
      display: flex; align-items: center; margin-bottom: 6px;
      padding: 4px; background-color: rgba(240, 240, 240, 0.5); border-radius: 4px;
    }
    .phone-entry span {
      vertical-align: middle; line-height: 1; font-size: 14px;
    }
    #toggleMenu {
      position: absolute; bottom: 10px; left: 50%;
      transform: translateX(-50%); z-index: 1100;
      padding: 8px 12px; border: none; background-color: white;
      border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      cursor: pointer; transition: background-color 0.3s; width: 50%;
    }
    #toggleMenu:hover { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="toggleMenu">Toggle Menu</button>
  <div id="controls">
    <button id="startDraw">Start Drawing</button>
    <button id="stopDraw">Stop Drawing</button>
    <button id="clear">Clear</button>
    <label for="colorPicker">Color:</label>
    <select id="colorPicker">
      <option value="red">Red</option>
      <option value="blue">Blue</option>
      <option value="green">Green</option>
      <option value="black">Black</option>
      <option value="purple">Purple</option>
      <option value="orange">Orange</option>
    </select>
    <button onclick="saveDrawings()">Save Now</button>
    <button id="switchView">Switch to Satellite</button>
    <button id="toggleLabels" onclick="togglePhoneLabels()">Hide Phone Labels</button>
    <div id="phoneList">
      <h4>Tracked Phones</h4>
      <div id="phoneEntries"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const map = L.map('map', { center: [37.7749, -122.4194], zoom: 5, layers: [streetLayer] });
    let currentBaseLayer = 'street';

    document.getElementById("switchView").onclick = function () {
      if (currentBaseLayer === 'street') {
        map.removeLayer(streetLayer); map.addLayer(satelliteLayer);
        currentBaseLayer = 'satellite'; this.innerText = "Switch to Street View";
      } else {
        map.removeLayer(satelliteLayer); map.addLayer(streetLayer);
        currentBaseLayer = 'street'; this.innerText = "Switch to Satellite";
      }
    };

    let drawing = false, currentLine = null, color = document.getElementById("colorPicker").value;
    let drawnItems = [];

    document.getElementById("startDraw").onclick = () => { drawing = true; disableMapInteraction(); };
    document.getElementById("stopDraw").onclick = () => { drawing = false; currentLine = null; enableMapInteraction(); };
    document.getElementById("clear").onclick = () => { drawnItems.forEach(line => map.removeLayer(line)); drawnItems = []; };
    document.getElementById("colorPicker").onchange = (e) => { color = e.target.value; };

    map.on("mousedown", function (e) {
      if (!drawing) return;
      currentLine = L.polyline([e.latlng], { color: color, weight: 3 }).addTo(map);
      drawnItems.push(currentLine);
      map.on("mousemove", onMouseMove);
      map.once("mouseup", () => { map.off("mousemove", onMouseMove); currentLine = null; });
    });

    function onMouseMove(e) {
      if (currentLine) currentLine.addLatLng(e.latlng);
    }

    function disableMapInteraction() {
      map.dragging.disable(); map.scrollWheelZoom.disable();
      map.doubleClickZoom.disable(); map.boxZoom.disable();
      map.keyboard.disable(); map.getContainer().style.cursor = 'crosshair';
    }

    function enableMapInteraction() {
      map.dragging.enable(); map.scrollWheelZoom.enable();
      map.doubleClickZoom.enable(); map.boxZoom.enable();
      map.keyboard.enable(); map.getContainer().style.cursor = '';
    }

    function saveDrawings() {
      const geojson = drawnItems.map(line => line.toGeoJSON());
      fetch("/save", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(geojson)
      }).then(res => res.json()).then(data => console.log("Saved:", data));
    }

    fetch("/load").then(res => res.json()).then(data => {
      data.forEach(feature => {
        const line = L.geoJSON(feature, { style: { color: feature.properties?.color || 'red', weight: 3 } }).addTo(map);
        drawnItems.push(line);
      });
    });

    const phones = {};

    function updateAllPhones() {
      fetch("/load_phones")
        .then(res => res.json())
        .then(data => {
          Object.keys(data).forEach(id => {
            const lat = data[id].lat;
            const lng = data[id].lng;
            if (typeof lat !== 'number' || typeof lng !== 'number') return;
            const latlng = [lat, lng];

            if (phones[id] && phones[id].marker) {
              phones[id].marker.setLatLng(latlng);
              phones[id].label.setLatLng(latlng);
            } else {
              phones[id] = {};
              phones[id].marker = L.marker(latlng, {
                icon: L.icon({
                  iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                  iconSize: [32, 32], iconAnchor: [16, 32]
                })
              }).addTo(map);
              phones[id].label = L.marker(latlng, {
                icon: L.divIcon({
                  className: 'phone-label', html: id, iconAnchor: [-5, -10]
                })
              }).addTo(map);
            }
          });
          updatePhoneList();
        })
        .catch(err => console.error("Failed to load phones:", err));
    }

    function updatePhoneList() {
      const phoneEntries = document.getElementById('phoneEntries');
      phoneEntries.innerHTML = '';
      const ids = Object.keys(phones);
      if (ids.length === 0) {
        phoneEntries.innerHTML = '<p>No phones being tracked</p>';
        return;
      }
      ids.forEach(id => {
        const entry = document.createElement('div');
        entry.className = 'phone-entry';
        const text = document.createElement('span');
        text.textContent = `${id}`;
        entry.appendChild(text);
        phoneEntries.appendChild(entry);
      });
    }

    let phoneLabelsVisible = true;

    function togglePhoneLabels() {
      phoneLabelsVisible = !phoneLabelsVisible;
      Object.keys(phones).forEach(id => {
        if (phones[id].label) {
          phones[id].label.setOpacity(phoneLabelsVisible ? 1 : 0);
        }
      });
      document.getElementById("toggleLabels").innerText =
        phoneLabelsVisible ? "Hide Phone Labels" : "Show Phone Labels";
    }

    window.addEventListener("beforeunload", () => {
      saveDrawings();
    });

    setInterval(updateAllPhones, 5000);
    updateAllPhones();

    document.getElementById('toggleMenu').addEventListener('click', () => {
      document.getElementById('controls').classList.toggle('hidden');
    });
  </script>
</body>
</html>
